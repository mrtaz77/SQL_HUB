# TRIGGERS : Solutions

- [A1](#a1) 
- [A2_B2](#a2_b2) 
- [B1](#b1) 

## A1
1. 
```sql
CREATE SEQUENCE LOG_ID_Seq START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER emp_insert
AFTER INSERT OR DELETE 
ON EMPLOYEES 
FOR EACH ROW
DECLARE
BEGIN 
INSERT INTO EMP_SAL_LOG VALUES(LOG_ID_Seq.NEXTVAL,:NEW.EMPLOYEE_ID,:OLD.SALARY,:NEW.SALARY,SYSDATE,null,'HR','APPROVED');
-- any random values are permissible for user_id and user_name
END;
/
```
2. 
```sql
CREATE OR REPLACE TRIGGER update_sal
BEFORE UPDATE OF SALARY
ON EMPLOYEES
FOR EACH ROW 
DECLARE
PREV_MOD_DATE DATE;
PERC NUMBER(10,4);
BEGIN
SELECT MAX(MOD_DATE) INTO PREV_MOD_DATE
FROM EMP_SAL_LOG
WHERE EMPLOYEE_ID = :NEW.EMPLOYEE_ID;

PERC := ROUND(((:OLD.SALARY-:NEW.SALARY)*100)/:OLD.SALARY,4);

IF PREV_MOD_DATE IS NOT NULL AND MONTHS_BETWEEN(SYSDATE, PREV_MOD_DATE) < 1 THEN
    DBMS_OUTPUT.PUT_LINE('SALARY UPDATE FAILED');
    INSERT INTO EMP_SAL_LOG VALUES(LOG_ID_Seq.NEXTVAL,:NEW.EMPLOYEE_ID,:OLD.SALARY,:NEW.SALARY,SYSDATE,null,'HR','DENIED');
    :NEW.SALARY := :OLD.SALARY;
ELSIF PERC < -20 OR PERC > 20 THEN 
    DBMS_OUTPUT.PUT_LINE('SALARY UPDATE FAILED');
    INSERT INTO EMP_SAL_LOG VALUES(LOG_ID_Seq.NEXTVAL,:NEW.EMPLOYEE_ID,:OLD.SALARY,:NEW.SALARY,SYSDATE,null,'HR','DENIED');
    :NEW.SALARY := :OLD.SALARY;
ELSE 
    INSERT INTO EMP_SAL_LOG VALUES(LOG_ID_Seq.NEXTVAL,:NEW.EMPLOYEE_ID,:OLD.SALARY,:NEW.SALARY,SYSDATE,null,'HR','APPROVED');
END IF;
END;
/
```

## A2_B2 

1. 
```sql
CREATE OR REPLACE TRIGGER insertCheck 
BEFORE INSERT
ON EMPLOYEES 
FOR EACH ROW 
BEGIN 
	IF (:NEW.EMAIL <> LOWER(:NEW.LAST_NAME)||'@orcl.com' ) THEN
		:NEW.EMAIL :=  LOWER(:NEW.LAST_NAME)||'.'||LOWER(:NEW.JOB_ID)||'@orcl.com';
	END IF;
	IF (:NEW.PHONE_NUMBER <> ('5555-'||:NEW.EMPLOYEE_ID||'-'||:NEW.DEPARTMENT_ID)) OR :NEW.DEPARTMENT_ID IS NULL THEN 
		IF :NEW.DEPARTMENT_ID IS NULL THEN 
			:NEW.PHONE_NUMBER := '5555-'||:NEW.EMPLOYEE_ID||'-'||'000';
		ELSE 
		  :NEW.PHONE_NUMBER := '5555-'||:NEW.EMPLOYEE_ID||'-'||:NEW.DEPARTMENT_ID;
		END IF;
		-- DBMS_OUTPUT.PUT_LINE(:NEW.PHONE_NUMBER);
		-- DBMS_OUTPUT.PUT_LINE('5555-'||:NEW.EMPLOYEE_ID||'-'||:NEW.DEPARTMENT_ID);
		-- DBMS_OUTPUT.PUT_LINE('5555-'||:NEW.EMPLOYEE_ID||'-'||'000');
	END IF;
	IF :NEW.SALARY < 0 THEN
        -- There is a problem with the question, -100 is not allowed in oracle.
		RAISE_APPLICATION_ERROR(-20100, 'Negative Value in Salary Filed. Insertion Aborted');
	END IF;
END;
/
```

2. 
```sql
CREATE OR REPLACE TRIGGER SAL_HISTORY 
AFTER INSERT OR UPDATE OF SALARY OR DELETE 
ON EMPLOYEES
FOR EACH ROW 
BEGIN
	IF INSERTING THEN 
		INSERT INTO SALARY_HISTORY(HISTORY_ID,EMPLOYEE_ID,OLD_SALARY,NEW_SALARY,CHANGE_DATE,CHANGE_TYPE) VALUES (Salary_History_Seq.NEXTVAL,:NEW.EMPLOYEE_ID,null,:NEW.SALARY,SYSDATE,'INSERT');
	ELSIF UPDATING('SALARY') THEN 
		INSERT INTO SALARY_HISTORY(HISTORY_ID,EMPLOYEE_ID,OLD_SALARY,NEW_SALARY,CHANGE_DATE,CHANGE_TYPE) VALUES (Salary_History_Seq.NEXTVAL,:NEW.EMPLOYEE_ID,:OLD.SALARY,:NEW.SALARY,SYSDATE,'UPDATE');
	ELSIF DELETING THEN 
		INSERT INTO SALARY_HISTORY(HISTORY_ID,EMPLOYEE_ID,OLD_SALARY,NEW_SALARY,CHANGE_DATE,CHANGE_TYPE) VALUES (Salary_History_Seq.NEXTVAL,:OLD.EMPLOYEE_ID,:OLD.SALARY,null,SYSDATE,'DELETE');
	END IF;
END;
/  
```

## B1 
1. 
```sql
CREATE OR REPLACE TRIGGER updSalAndJobId
BEFORE UPDATE
OF SALARY,JOB_ID
ON EMPLOYEES
FOR EACH ROW
DECLARE
OLDMINSAL NUMBER(10,2);
NEWMINSAL NUMBER(10,2);
OLDMAXSAL NUMBER(10,2);
NEWMAXSAL NUMBER(10,2);
BEGIN
SELECT MIN_SALARY INTO OLDMINSAL FROM JOBS WHERE JOB_ID = :OLD.JOB_ID;
SELECT MIN_SALARY INTO NEWMINSAL FROM JOBS WHERE JOB_ID = :NEW.JOB_ID;
SELECT MAX_SALARY INTO OLDMAXSAL FROM JOBS WHERE JOB_ID = :OLD.JOB_ID;
SELECT MAX_SALARY INTO NEWMAXSAL FROM JOBS WHERE JOB_ID = :NEW.JOB_ID;
IF NEWMINSAL < OLDMINSAL THEN
	RAISE_APPLICATION_ERROR(-20120,'MIN_SALARY OF NEW JOB_ID IS LESS THAN THAT OF OLD JOB_ID');
END IF;
IF :NEW.SALARY < NEWMINSAL THEN 
-- 	SELECT NEWMINSAL INTO :NEW.SALARY FROM DUAL;
	:NEW.SALARY := NEWMINSAL;
ELSIF :NEW.SALARY > NEWMAXSAL THEN 
	-- 	SELECT NEWMAXSAL INTO :NEW.SALARY FROM DUAL;
	:NEW.SALARY := NEWMAXSAL;
END IF; 
END;
/  
```

2. 
```sql
CREATE OR REPLACE TRIGGER MANID 
BEFORE INSERT 
ON EMPLOYEES 
FOR EACH ROW 
DECLARE
BEGIN
  IF :NEW.MANAGER_ID IS NULL THEN
    DBMS_OUTPUT.PUT_LINE('No manager of '||:NEW.FIRST_NAME||' has been assigned');
    SELECT MANAGER_ID INTO :NEW.MANAGER_ID FROM DEPARTMENTS WHERE DEPARTMENT_ID = :NEW.DEPARTMENT_ID;
  END IF;
END;
/
```
